{% extends "base.html" %}
{% block title %}Practice - DS Interview Prep{% endblock %}

{% block content %}
<div class="practice-page">
    <div class="module-header">
        <h1>Practice</h1>
        <p class="subtitle">{{ items|length }} question{{ 's' if items|length != 1 else '' }} available</p>
    </div>

    <div class="filter-bar">
        <form class="filter-form" method="get" action="/practice">
            <select name="category" class="form-select" onchange="this.form.submit()">
                <option value="">all categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {{ 'selected' if selected_category == cat }}>{{ cat }}</option>
                {% endfor %}
            </select>
            <select name="type" class="form-select" onchange="this.form.submit()">
                <option value="">all types</option>
                {% for t in types %}
                <option value="{{ t }}" {{ 'selected' if selected_type == t }}>{{ t|replace('_', ' ') }}</option>
                {% endfor %}
            </select>
            <select name="source" class="form-select" onchange="this.form.submit()">
                <option value="">all sources</option>
                <option value="modules" {{ 'selected' if selected_source == 'modules' }}>modules</option>
                <option value="challenges" {{ 'selected' if selected_source == 'challenges' }}>challenges</option>
            </select>
            <input type="text" name="search" class="form-input" placeholder="search..."
                   value="{{ search_query }}" style="max-width: 200px;">
            <button type="submit" class="btn btn-secondary btn-sm">filter</button>
        </form>
    </div>

    <div class="practice-list">
        {% for item in items %}
        <div class="practice-item {% if item.is_challenge %}practice-challenge{% endif %}" id="item-{{ item.id }}">
            <div class="practice-item-header">
                <div class="practice-item-tags">
                    <span class="category-tag cat-{{ item.category }}">{{ item.category }}</span>
                    {% if item.is_challenge %}
                    <span class="badge badge-challenge">challenge</span>
                    {% if item.difficulty %}
                    <span class="badge badge-difficulty">{{ item.difficulty }}</span>
                    {% endif %}
                    {% else %}
                    <span class="question-type-tag">{{ item.question_type|replace('_', ' ') }}</span>
                    {% endif %}
                </div>
                <button class="btn btn-ghost btn-sm toggle-answer-btn" onclick="toggleAnswer('{{ item.id }}')">
                    show answer
                </button>
            </div>

            {% if item.is_challenge and item.scenario %}
            <div class="practice-scenario">{{ item.scenario }}</div>
            {% endif %}

            <div class="practice-prompt">
                {% if item.is_challenge %}
                <h3>{{ item.title }}</h3>
                {% endif %}
                {{ item.prompt|md }}
            </div>

            {% if item.is_challenge and item.concepts %}
            <div class="practice-concepts">
                {% for concept in item.concepts %}
                <span class="concept-tag">{{ concept }}</span>
                {% endfor %}
            </div>
            {% endif %}

            {% if item.is_challenge and item.sql_setup %}
            <details class="schema-panel">
                <summary>schema &amp; sample data</summary>
                <pre><code class="language-sql">{{ item.sql_setup }}</code></pre>
            </details>

            <div class="sql-workspace" id="workspace-{{ item.id }}">
                <div class="code-editor-wrapper">
                    <div class="code-editor-header">sql</div>
                    <textarea class="code-editor sql-challenge-editor"
                              id="sql-editor-{{ item.id }}"
                              rows="10"
                              placeholder="Write your SQL query here..."></textarea>
                </div>
                <div class="sql-actions">
                    <button class="btn btn-primary btn-sm"
                            onclick="runSQL('{{ item.id }}')">
                        run query
                    </button>
                    <span class="sql-status" id="status-{{ item.id }}"></span>
                </div>
                <div class="sql-results" id="results-{{ item.id }}"></div>
            </div>
            {% endif %}

            <div class="practice-answer hidden" id="answer-{{ item.id }}">
                <h4>Answer</h4>
                {% if item.rubric %}
                <div class="rubric-checklist">
                    <h4>Key Points</h4>
                    {% for point in item.rubric %}
                    <div class="rubric-item">
                        <input type="checkbox" id="rubric-{{ item.id }}-{{ loop.index }}">
                        <label for="rubric-{{ item.id }}-{{ loop.index }}">{{ point }}</label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if item.answer is looks_like_code %}
                <pre><code class="language-sql">{{ item.answer }}</code></pre>
                {% else %}
                <div class="model-answer-text">{{ item.answer|md }}</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {% if not items %}
        <div class="empty-state">
            <h2>No questions found</h2>
            <p>Try adjusting your filters or importing some content.</p>
            <a href="/admin/ingest" class="btn btn-primary">import content</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleAnswer(id) {
    var el = document.getElementById('answer-' + id);
    var btn = document.querySelector('#item-' + id + ' .toggle-answer-btn');
    if (el.classList.contains('hidden')) {
        el.classList.remove('hidden');
        btn.textContent = 'hide answer';
        el.querySelectorAll('pre code').forEach(function(block) {
            hljs.highlightElement(block);
        });
    } else {
        el.classList.add('hidden');
        btn.textContent = 'show answer';
    }
}

function runSQL(challengeId) {
    var editor = document.getElementById('sql-editor-' + challengeId);
    var status = document.getElementById('status-' + challengeId);
    var resultsDiv = document.getElementById('results-' + challengeId);
    var sql = editor.value.trim();

    if (!sql) {
        status.textContent = 'write a query first';
        status.className = 'sql-status status-error';
        return;
    }

    status.textContent = 'running...';
    status.className = 'sql-status status-running';
    resultsDiv.innerHTML = '';

    fetch('/practice/sql-run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({challenge_id: challengeId, sql: sql})
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
        if (data.error) {
            status.textContent = 'error';
            status.className = 'sql-status status-error';
            resultsDiv.innerHTML = '<div class="sql-error">' + escapeHtml(data.error) + '</div>';
            return;
        }

        var html = '';

        // pass/fail banner
        if (data.is_correct) {
            html += '<div class="sql-pass">correct — your output matches the expected result</div>';
            status.textContent = 'pass';
            status.className = 'sql-status status-pass';
        } else {
            html += '<div class="sql-fail">not quite — compare your output with the expected result below</div>';
            status.textContent = 'mismatch';
            status.className = 'sql-status status-fail';
        }

        // your output
        html += '<div class="sql-result-section">';
        html += '<h4>Your Output (' + data.user_rows.length + ' row' + (data.user_rows.length !== 1 ? 's' : '') + ')</h4>';
        html += buildTable(data.user_columns, data.user_rows);
        html += '</div>';

        // expected output
        html += '<div class="sql-result-section">';
        html += '<h4>Expected Output (' + data.expected_rows.length + ' row' + (data.expected_rows.length !== 1 ? 's' : '') + ')</h4>';
        html += buildTable(data.expected_columns, data.expected_rows);
        html += '</div>';

        resultsDiv.innerHTML = html;
    })
    .catch(function(err) {
        status.textContent = 'error';
        status.className = 'sql-status status-error';
        resultsDiv.innerHTML = '<div class="sql-error">Request failed: ' + escapeHtml(err.message) + '</div>';
    });
}

function buildTable(columns, rows) {
    if (!columns || columns.length === 0) return '<p class="text-muted">no results</p>';
    var html = '<div class="result-table-wrap"><table class="result-table"><thead><tr>';
    for (var i = 0; i < columns.length; i++) {
        html += '<th>' + escapeHtml(String(columns[i])) + '</th>';
    }
    html += '</tr></thead><tbody>';
    for (var r = 0; r < rows.length; r++) {
        html += '<tr>';
        for (var c = 0; c < rows[r].length; c++) {
            var val = rows[r][c];
            html += '<td>' + escapeHtml(val === null ? 'NULL' : String(val)) + '</td>';
        }
        html += '</tr>';
    }
    html += '</tbody></table></div>';
    return html;
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}
</script>
{% endblock %}
